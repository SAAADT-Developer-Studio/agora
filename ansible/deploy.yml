---
- name: Deploy Scraper Stack to Hetzner VM
  hosts: hetzner_vms
  become: true

  vars:
    docker_image_name: "{{ lookup('env', 'DOCKER_IMAGE_NAME') }}"
    docker_image_tag: "{{ lookup('env', 'DOCKER_IMAGE_TAG') }}"
    docker_hub_username: "{{ lookup('env', 'DOCKER_HUB_USERNAME') }}"
    docker_hub_token: "{{ lookup('env', 'DOCKER_HUB_TOKEN') }}"
    project_dir: /opt/scraper
    app_secrets:
      # Docker image configuration
      DOCKER_HUB_USERNAME: "{{ docker_hub_username }}"
      DOCKER_IMAGE_TAG: "{{ docker_image_tag }}"
      # App configuration
      APP_ENV: production
      GOOGLE_API_KEY: "{{ lookup('env', 'GOOGLE_API_KEY') }}"
      OPENAI_API_KEY: "{{ lookup('env', 'OPENAI_API_KEY') }}"
      DATABASE_URL: "{{ lookup('env', 'DATABASE_URL') }}"
      PEXELS_API_KEY: "{{ lookup('env', 'PEXELS_API_KEY') }}"
      # Grafana Alloy configuration
      GRAFANA_LOKI_URL: "{{ lookup('env', 'GRAFANA_LOKI_URL') }}"
      GRAFANA_LOKI_USERNAME: "{{ lookup('env', 'GRAFANA_LOKI_USERNAME') }}"
      GRAFANA_PROMETHEUS_URL: "{{ lookup('env', 'GRAFANA_PROMETHEUS_URL') }}"
      GRAFANA_PROMETHEUS_USERNAME: "{{ lookup('env', 'GRAFANA_PROMETHEUS_USERNAME') }}"
      GRAFANA_CLOUD_API_KEY: "{{ lookup('env', 'GRAFANA_CLOUD_API_KEY') }}"

  tasks:
    - name: Ensure Docker login
      community.docker.docker_login:
        username: "{{ docker_hub_username }}"
        password: "{{ docker_hub_token }}"
      no_log: true

    - name: Create project directory
      ansible.builtin.file:
        path: "{{ project_dir }}"
        state: directory
        mode: "0755"

    - name: Copy docker-compose.yml to server
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../scraper/docker-compose.yml"
        dest: "{{ project_dir }}/docker-compose.yml"
        mode: "0644"

    - name: Copy config.alloy to server
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../scraper/config.alloy"
        dest: "{{ project_dir }}/config.alloy"
        mode: "0644"

    - name: Create .env file with secrets
      ansible.builtin.copy:
        content: |
          {% for key, value in app_secrets.items() %}
          {{ key }}={{ value }}
          {% endfor %}
        dest: "{{ project_dir }}/.env"
        mode: "0600"
      no_log: true

    - name: Pull latest images
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ project_dir }}"
      register: pull_result
      changed_when: "'Downloaded' in pull_result.stdout or 'Pull complete' in pull_result.stdout"

    - name: Start docker-compose stack
      ansible.builtin.command:
        cmd: docker compose up -d --remove-orphans
        chdir: "{{ project_dir }}"
      register: compose_result
      changed_when: "'Started' in compose_result.stderr or 'Creating' in compose_result.stderr"

    - name: Wait for containers to be healthy
      ansible.builtin.pause:
        seconds: 5

    - name: Verify scraper container is running
      community.docker.docker_container_info:
        name: scraper
      register: scraper_info

    - name: Verify alloy container is running
      community.docker.docker_container_info:
        name: alloy
      register: alloy_info

    - name: Fail if scraper container is not running
      ansible.builtin.fail:
        msg: "Scraper container is not running or has crashed."
      when: scraper_info.container.State.Status != "running"

    - name: Fail if alloy container is not running
      ansible.builtin.fail:
        msg: "Alloy container is not running or has crashed."
      when: alloy_info.container.State.Status != "running"

    - name: Remove dangling images to save space
      community.docker.docker_prune:
        containers: false
        images: true
        images_filters:
          dangling: false
        networks: false
        volumes: false
